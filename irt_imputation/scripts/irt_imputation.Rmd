---
title: "irt_imputation"
output: html_document
date: "2025-12-11"
---

```{r}
library(mirt)

irt_impute_scenario <- function(prefix, n_factors = 1) {
  message("Running IRT imputation for: ", prefix)

  # ---------- 1. Load data ----------
  X_obs  <- as.matrix(read.csv(paste0(prefix, "_X_obs.csv")))
  X_full <- as.matrix(read.csv(paste0(prefix, "_X_full.csv")))
  mask_raw <- as.matrix(read.csv(paste0(prefix, "_mask.csv")))

  # IMPORTANT (based on your debug output):
  # mask_raw != 0  means MISSING (not observed)
  miss <- (mask_raw != 0)   # TRUE = missing cells
  obs  <- !miss             # TRUE = observed cells

  message("Loading data done")
  message("observed proportion: ", round(mean(obs), 4))
  message("missing proportion: ", round(mean(miss), 4))
  message("missing cells count: ", sum(miss))
  message("X_obs NA count: ", sum(is.na(X_obs)))

  # ---------- 2. Fit 2PL model ----------
  mod <- mirt(X_obs, n_factors, itemtype = "2PL", verbose = FALSE)

  # ---------- 3. Get person scores ----------
  Theta <- fscores(mod, method = "EAP")  # N × n_factors
  N <- nrow(Theta)
  I <- ncol(X_obs)

  # ---------- 4. Compute predicted probabilities ----------
  P <- matrix(NA_real_, nrow = N, ncol = I)
  for (j in 1:I) {
    item_j <- extract.item(mod, j)
    pt <- probtrace(item_j, Theta)   # columns: P(X=0), P(X=1)
    P[, j] <- pt[, 2]
  }

  # ---------- 5. Build imputed matrix (fill MISSING only) ----------
  X_imp <- X_obs
  X_imp[miss] <- P[miss]

  out_file <- paste0(prefix, "_X_IRT_imputed.csv")
  write.csv(X_imp, out_file, row.names = FALSE)
  message("Saved IRT imputed matrix to: ", out_file)

  # ---------- 6. Identify people with NO observed responses ----------
  valid_rows <- rowSums(!is.na(X_obs)) > 0
  num_removed <- sum(!valid_rows)
  if (num_removed > 0) {
    message("Excluded ", num_removed,
            " persons with 100% missing responses from evaluation.")
  }

  # ---------- 7. Build evaluation mask: missing cells among valid persons ----------
  eval_miss <- miss
  eval_miss[!valid_rows, ] <- FALSE
  eval_miss[is.na(X_full)] <- FALSE  # safety

  message("eval missing count: ", sum(eval_miss))
  message("X_imp NA on eval missing: ", sum(is.na(X_imp[eval_miss])))

  if (sum(eval_miss) == 0) {
    warning(prefix, ": no evaluable missing cells. Returning NA for metrics.")
    rmse <- NA_real_
    bce  <- NA_real_
  } else {
    # ---------- 8. RMSE on missing-but-evaluable entries ----------
    rmse <- sqrt(mean((X_imp[eval_miss] - X_full[eval_miss])^2))

    # ---------- 9. BCE (log loss) on missing-but-evaluable entries ----------
    eps <- 1e-8
    p <- pmin(pmax(X_imp, eps), 1 - eps)

    bce <- -mean(
      X_full[eval_miss] * log(p[eval_miss]) +
        (1 - X_full[eval_miss]) * log(1 - p[eval_miss])
    )
  }

  message(prefix,
          " | IRT RMSE (missing): ", ifelse(is.na(rmse), "NA", round(rmse, 4)),
          " | IRT BCE (missing): ", ifelse(is.na(bce),  "NA", round(bce,  4)))

  return(invisible(list(
    model = mod,
    Theta = Theta,
    P = P,
    X_imputed = X_imp,
    miss_mask = miss,
    eval_miss = eval_miss,
    rmse = rmse,
    bce = bce,
    removed_persons = num_removed
  )))
}
```


```{r}
setwd("~/Desktop/sem2/irtimputation")

for (p in c("MCAR40", "MCAR50", "MCAR60", "MCAR70")) {
  irt_impute_scenario(p)
}
```


```{r}
setwd("~/Desktop/sem2/irtimputation/mach")  

for (p in c("MCAR60", "MAR60", "MNAR60")) {
  irt_impute_scenario(p)
}
```



```{r}
setwd("~/Desktop")

scenarios <- c(

  # extended (1–5)
  "MNAR_Y1", "MNAR_Y2",
  "NR_simple", "NR_speed",
  "Booklet50_MCAR20",

  # heterogeneity (6–8)
  "DIFMCAR60", "DIFMNARth60",
  "GroupMAR60"
)

for (p in scenarios) {
  message("Running imputation for: ", p)
  irt_impute_scenario(p)
}
```
